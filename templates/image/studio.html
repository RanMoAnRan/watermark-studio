{% extends "base.html" %}
{% set title = "图片水印" %}
{% set active = "img" %}

{% block content %}
  {% set initial_tab = (tab or "")|lower %}
  {% if initial_tab != "remove" and initial_tab != "add" %}
    {% set initial_tab = "add" %}
  {% endif %}

  <div class="hero">
    <h2>图片水印</h2>
    <p>添加水印 / 去水印：处理后可预览并下载。</p>
  </div>

  <div class="card wide" style="margin-bottom: 20px;">
    <div class="bd">
      <div class="row" style="gap: 10px; flex-wrap: wrap;">
        <button id="imgTabAddBtn" class="btn {{ 'primary' if initial_tab == 'add' else 'secondary' }}" type="button">加水印</button>
        <button id="imgTabRemoveBtn" class="btn {{ 'primary' if initial_tab == 'remove' else 'secondary' }}" type="button">去水印</button>
        <span class="muted">切换不会清空当前结果</span>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/forms_ajax.js', v=static_version) }}"></script>
  <script src="{{ url_for('static', filename='js/image_region_select.js', v=static_version) }}"></script>

  <div id="imgTabAdd" style="{% if initial_tab != 'add' %}display:none{% endif %}">
    {% with
      error=add_error,
      text=add_text,
      options=add_options,
      original_name=add_original_name,
      preview_url=add_preview_url,
      download_url=add_download_url,
      original_download_url=add_original_download_url,
      original_preview_url=add_original_preview_url,
      original_job_id=add_original_job_id,
      job_id=add_job_id
    %}
      {% include "image/tabs/add_watermark.html" %}
    {% endwith %}
  </div>

  <div id="imgTabRemove" style="{% if initial_tab != 'remove' %}display:none{% endif %}">
    {% with
      error=remove_error,
      options=remove_options,
      original_name=remove_original_name,
      preview_url=remove_preview_url,
      download_url=remove_download_url,
      job_id=remove_job_id
    %}
      {% include "image/tabs/remove_watermark.html" %}
    {% endwith %}
  </div>

  <script>
    (function () {
      const studioPath = {{ url_for('image.studio_page') | tojson }};
      const btnAdd = document.getElementById("imgTabAddBtn");
      const btnRemove = document.getElementById("imgTabRemoveBtn");
      const tabAdd = document.getElementById("imgTabAdd");
      const tabRemove = document.getElementById("imgTabRemove");

      function normalize(which) {
        return (String(which || "").toLowerCase() === "remove") ? "remove" : "add";
      }

      function setTab(which, opts) {
        const options = opts || {};
        const tab = normalize(which);
        const isAdd = tab === "add";

        if (tabAdd) tabAdd.style.display = isAdd ? "" : "none";
        if (tabRemove) tabRemove.style.display = isAdd ? "none" : "";

        if (btnAdd) btnAdd.className = isAdd ? "btn primary" : "btn secondary";
        if (btnRemove) btnRemove.className = isAdd ? "btn secondary" : "btn primary";

        if (options.updateUrl !== false) {
          try {
            const u = new URL(window.location.href);
            u.pathname = studioPath;
            u.searchParams.set("tab", tab);
            history.replaceState(null, "", u.pathname + u.search + u.hash);
          } catch (_) {}
        }

        setTimeout(() => window.dispatchEvent(new Event("resize")), 0);
      }

      window.__setImageStudioTab = (which) => setTab(which, { updateUrl: true });

      if (btnAdd) btnAdd.addEventListener("click", () => setTab("add"));
      if (btnRemove) btnRemove.addEventListener("click", () => setTab("remove"));

      window.addEventListener("popstate", () => {
        try {
          const u = new URL(window.location.href);
          setTab(u.searchParams.get("tab"), { updateUrl: false });
        } catch (_) {
          setTab("add", { updateUrl: false });
        }
      });
    })();
  </script>
{% endblock %}

