{% extends "base.html" %}
{% set title = "图片切分/拼装" %}
{% set active = "img_slice" %}

{% block content %}
  {% set initial_tab = (tab or "")|lower %}
  {% if initial_tab != "compose" and initial_tab != "slice" %}
    {% set initial_tab = "compose" if (compose_error or preview_url or download_url) else "slice" %}
  {% endif %}

	  <div class="hero">
	    <h2>图片切分/拼装</h2>
	    <p>切分：一张图按样式拆分多张；拼装：多张图按样式组合成一张（后端生成预览并可下载）。</p>
	  </div>

  <div class="grid">
    <div class="card wide">
      <div class="bd">
	        <div class="row" style="margin-bottom: 12px;">
	          <button id="tabSlice" class="btn {{ 'primary' if initial_tab == 'slice' else 'secondary' }}" type="button">切分</button>
	          <button id="tabCompose" class="btn {{ 'primary' if initial_tab == 'compose' else 'secondary' }}" type="button">拼装</button>
	          <span class="muted">切换后当前配置会保留</span>
	        </div>

        <div id="imgSliceError" class="error" style="margin-bottom: 12px; {% if not error %}display:none{% endif %}">
          <span id="imgSliceErrorText">{{ error or "" }}</span>
        </div>

	        <form id="imgSliceForm" action="{{ url_for('image.slice_submit') }}" method="post" enctype="multipart/form-data" target="_blank" style="{% if initial_tab != 'slice' %}display:none{% endif %}">
	          <div class="cols">
	            <div class="col-7">
              <div class="field">
                <label>选择图片</label>
                <input id="imgSliceFile" type="file" name="file" accept="image/*" required />
              </div>
              <div class="field">
                <label>切分样式</label>
                {% set m = (options.mode if options else 'grid_3') %}
                <select id="imgSliceMode" name="mode">
                  <option value="split_v2" {% if m == 'split_v2' %}selected{% endif %}>两张（左右对半）</option>
                  <option value="split_h2" {% if m == 'split_h2' %}selected{% endif %}>两张（上下对半）</option>
                  <option value="grid_2" {% if m == 'grid_2' %}selected{% endif %}>四宫格（2×2）</option>
                  <option value="grid_2x3" {% if m == 'grid_2x3' %}selected{% endif %}>六宫格（2×3）</option>
                  <option value="grid_3" {% if m == 'grid_3' %}selected{% endif %}>九宫格（3×3）</option>
                </select>
              </div>
            </div>

            <div class="col-5">
              <div class="field">
                <label>输出格式</label>
                {% set f = (options.output_format if options else 'same') %}
                <select name="output_format">
                  <option value="same" {% if f == 'same' %}selected{% endif %}>跟随原图</option>
                  <option value="png" {% if f == 'png' %}selected{% endif %}>PNG</option>
                  <option value="jpg" {% if f == 'jpg' %}selected{% endif %}>JPG（透明会变白底）</option>
                  <option value="webp" {% if f == 'webp' %}selected{% endif %}>WEBP</option>
                </select>
              </div>
              <button class="btn primary" type="submit">一键下载切图（zip）</button>
                <div class="hint">提示：下载会在新标签页触发，当前页保留预览。</div>
            </div>
          </div>
        </form>

	        <div class="preview" style="margin-top: 14px; {% if initial_tab != 'slice' %}display:none{% endif %}">
	          <div class="bar">
	            <div class="title">切分预览</div>
	            <div id="imgSlicePreviewMeta" class="muted"></div>
	          </div>
	          <div class="body">
	            <canvas id="imgSliceCanvas" style="height: 520px;"></canvas>
	          </div>
	        </div>

	        <div id="composeWrap" style="{% if initial_tab == 'slice' %}display:none{% endif %}">
	          <form id="imgComposeForm" action="{{ url_for('image.compose_submit') }}" method="post" enctype="multipart/form-data">
	            <div class="cols" style="margin-top: 16px;">
	              <div class="col-7">
	                <div id="imgComposeError" class="error" style="margin-bottom: 12px; {% if not compose_error %}display:none{% endif %}">
	                  <span id="imgComposeErrorText">{{ compose_error or "" }}</span>
	                </div>

                <div class="field">
                  <label>选择多张图片</label>
                  <input id="imgComposeFiles" type="file" name="files" accept="image/*" multiple required />
                  <div class="hint">为兼容 Edge 等浏览器，拼装改为后端生成：点击“生成预览”后可预览并下载成品。</div>
                </div>

	                <div class="preview">
	                  <div class="bar">
	                    <div class="title">拼装预览（美图秀秀风格模板）</div>
	                    <div id="imgComposeMeta" class="muted">{% if compose_meta %}{{ (compose_meta.layout_name or '') ~ ' · ' ~ compose_meta.out_w ~ '×' ~ compose_meta.out_h ~ 'px' }}{% endif %}</div>
	                  </div>
	                  <div class="body" style="padding: 12px;">
	                    <img id="imgComposePreview" alt="compose" style="width: 100%; display:block;" {% if preview_url %}src="{{ preview_url }}"{% endif %} />
	                  </div>
	                </div>

                <div class="preview" style="margin-top: 12px;">
                  <div class="bar">
                    <div class="title">下载</div>
                    <div class="muted">生成后可直接下载</div>
                  </div>
			                  <div class="body">
			                    <div class="row" style="padding: 12px;">
			                      <a id="imgComposeDownload" class="btn primary" href="{{ download_url or '#' }}" style="{% if not download_url %}pointer-events:none; opacity:0.6;{% endif %}">下载拼装图片</a>
			                      <a class="btn secondary" href="{{ url_for('image.slice_page') }}?tab=compose">清空重新拼</a>
			                    </div>
			                  </div>
			                </div>
              </div>

              <div class="col-5">
                <div class="field">
                  <label>拼装样式</label>
                  <select id="imgComposeLayout" name="layout">
                    <option value="mt_2_lr" selected>两张（左右）</option>
                    <option value="mt_2_tb">两张（上下）</option>
                    <option value="mt_3_lr">三张（左右）</option>
                    <option value="mt_3_tb">三张（上下）</option>
                    <option value="mt_big_left_2">三张（左大右二）</option>
                    <option value="mt_big_top_2">三张（上大下二）</option>
                    <option value="mt_4">四宫格（2×2）</option>
                    <option value="mt_6">六宫格（2×3）</option>
                    <option value="mt_9">九宫格（3×3）</option>
                  </select>
                </div>
                <div class="field">
                  <label>导出宽度（像素）</label>
                  <input id="imgComposeWidth" name="out_w_px" type="number" min="512" max="8192" value="2048" />
                  <div class="hint">高度会按样式自动计算；越大越清晰但生成更慢。</div>
                </div>
                <div class="field">
                  <label>边距 / 间距</label>
                  <div class="row">
                    <div style="flex:1; min-width: 120px;">
                      <input name="padding_px" type="number" min="0" max="400" value="12" placeholder="外边距(px)" />
                    </div>
                    <div style="flex:1; min-width: 120px;">
                      <input name="gap_px" type="number" min="0" max="200" value="12" placeholder="间距(px)" />
                    </div>
                  </div>
                </div>
                <div class="field">
                  <label>圆角 / 背景</label>
                  <div class="row">
                    <div style="flex:1; min-width: 120px;">
                      <input name="radius_px" type="number" min="0" max="400" value="18" placeholder="圆角(px)" />
                    </div>
                    <div style="flex:1; min-width: 120px;">
                      <input name="bg_color" type="color" value="#ffffff" />
                    </div>
                  </div>
                </div>
                <div class="field">
                  <label>导出格式</label>
                  <select id="imgComposeFormat" name="output_format">
                    <option value="png">PNG（无损）</option>
                    <option value="webp">WEBP（无损）</option>
                    <option value="jpg">JPG（高质量）</option>
                  </select>
                </div>
                <div class="row">
                  <button id="imgComposeSubmit" class="btn primary" type="submit">生成预览</button>
                  <button class="btn secondary" type="reset">重置参数</button>
                </div>
                <div class="hint">提示：图片会按“居中裁切”填充每个格子（类似美图秀秀拼图）；想换顺序请在文件选择器里调整选图顺序。</div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const tabSlice = document.getElementById("tabSlice");
      const tabCompose = document.getElementById("tabCompose");
      const composeWrap = document.getElementById("composeWrap");

      const form = document.getElementById("imgSliceForm");
      const fileInput = document.getElementById("imgSliceFile");
      const modeSelect = document.getElementById("imgSliceMode");
      const canvas = document.getElementById("imgSliceCanvas");
      const meta = document.getElementById("imgSlicePreviewMeta");
      const ctx = canvas.getContext("2d");

      let loadedImg = null;
      let loadedUrl = null;

      function modeToGrid(mode) {
        if (mode === "split_v2") return [1, 2];
        if (mode === "split_h2") return [2, 1];
        if (mode === "grid_2") return [2, 2];
        if (mode === "grid_2x3") return [2, 3];
        return [3, 3];
      }

      function clear() {
        loadedImg = null;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        meta.textContent = "";
      }

      function setTab(which) {
        const isSlice = which === "slice";
        form.style.display = isSlice ? "" : "none";
        canvas.closest(".preview").style.display = isSlice ? "" : "none";
        composeWrap.style.display = isSlice ? "none" : "";
        tabSlice.className = isSlice ? "btn primary" : "btn secondary";
        tabCompose.className = isSlice ? "btn secondary" : "btn primary";
        setTimeout(() => window.dispatchEvent(new Event("resize")), 0);
      }

      function draw() {
        if (!loadedImg) return;

        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const cssW = Math.max(1, rect.width || 1);
        const cssH = 520;

        canvas.style.height = cssH + "px";
        canvas.width = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, cssW, cssH);
        ctx.fillStyle = "#0b1220";
        ctx.fillRect(0, 0, cssW, cssH);

        const imgW = loadedImg.width;
        const imgH = loadedImg.height;
        const scale = Math.min(cssW / imgW, cssH / imgH);
        const drawW = Math.round(imgW * scale);
        const drawH = Math.round(imgH * scale);
        const offsetX = Math.round((cssW - drawW) / 2);
        const offsetY = Math.round((cssH - drawH) / 2);
        ctx.drawImage(loadedImg, offsetX, offsetY, drawW, drawH);

        const [rows, cols] = modeToGrid(modeSelect.value);
        meta.textContent = `预览：${rows}×${cols}`;

        function drawLine(x1, y1, x2, y2) {
          // Dark outline + light core so it’s visible on both dark and white images.
          ctx.save();
          ctx.shadowColor = "rgba(0,0,0,0)";
          ctx.shadowBlur = 0;

          ctx.lineCap = "butt";
          ctx.setLineDash([6, 4]);

          ctx.lineWidth = 3;
          ctx.strokeStyle = "rgba(0,0,0,0.75)";
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();

          ctx.lineWidth = 1;
          ctx.strokeStyle = "rgba(255,255,255,0.95)";
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();

          ctx.restore();
        }

        for (let c = 1; c < cols; c++) {
          const x = offsetX + (drawW * c) / cols;
          drawLine(x, offsetY, x, offsetY + drawH);
        }
        for (let r = 1; r < rows; r++) {
          const y = offsetY + (drawH * r) / rows;
          drawLine(offsetX, y, offsetX + drawW, y);
        }
      }

      function loadFile() {
        const f = fileInput.files && fileInput.files[0];
        if (!f) {
          if (loadedUrl) URL.revokeObjectURL(loadedUrl);
          loadedUrl = null;
          clear();
          return;
        }
        if (loadedUrl) URL.revokeObjectURL(loadedUrl);
        loadedUrl = URL.createObjectURL(f);

        const img = new Image();
        img.onload = () => {
          loadedImg = img;
          draw();
        };
        img.onerror = () => {
          clear();
        };
        img.src = loadedUrl;
      }

      fileInput.addEventListener("change", loadFile);
      modeSelect.addEventListener("change", draw);
      window.addEventListener("resize", () => {
        if (loadedImg) draw();
      });

		      clear();
		      const params = new URLSearchParams(window.location.search || "");
		      const serverTab = "{{ (tab or '')|lower }}";
		      const tab = (params.get("tab") || serverTab || "").toLowerCase();
		      setTab(tab === "compose" ? "compose" : "slice");
		      tabSlice.addEventListener("click", () => setTab("slice"));
		      tabCompose.addEventListener("click", () => setTab("compose"));
		    })();
	  </script>
  <script src="{{ url_for('static', filename='js/forms_ajax.js', v=static_version) }}"></script>
  <script>
	    submitAjaxForm({
	      form: "#imgComposeForm",
	      errorBox: "#imgComposeError",
	      errorText: "#imgComposeErrorText",
	      submitBtn: "button[type='submit']",
	      submittingText: "生成中…",
	      onStart: () => {
	        const img = document.querySelector("#imgComposePreview");
	        const meta = document.querySelector("#imgComposeMeta");
	        const dl = document.querySelector("#imgComposeDownload");
	
	        if (img) {
	          img.onerror = null;
	          img.removeAttribute("src");
	        }
	        if (meta) meta.textContent = "";
	        if (dl) {
	          dl.href = "#";
	          dl.style.pointerEvents = "none";
	          dl.style.opacity = "0.6";
	        }
	      },
	      onSuccess: (data) => {
	        const img = document.querySelector("#imgComposePreview");
	        const meta = document.querySelector("#imgComposeMeta");
	        const dl = document.querySelector("#imgComposeDownload");

        if (img) {
          img.onerror = () => {
            const err = document.querySelector("#imgComposeError");
            const errText = document.querySelector("#imgComposeErrorText");
            if (err) err.style.display = "";
            if (errText) errText.textContent = "预览图片加载失败（可尝试新标签打开预览链接）。";
          };
          img.src = data.preview_url;
        }
        if (meta && data.meta) {
          meta.textContent = `${data.meta.layout_name || ""} · ${data.meta.out_w}×${data.meta.out_h}px`;
        }

	        if (dl) {
	          dl.href = data.download_url;
	          dl.style.pointerEvents = "";
	          dl.style.opacity = "1";
	        }
	      },
	      onError: () => {
	        const dl = document.querySelector("#imgComposeDownload");
	        if (dl) {
	          dl.href = "#";
	          dl.style.pointerEvents = "none";
	          dl.style.opacity = "0.6";
	        }
	      },
	    });
	  </script>
{% endblock %}
