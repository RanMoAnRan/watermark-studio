{% extends "base.html" %}
{% set title = "图片切分/拼装" %}
{% set active = "img_slice" %}

{% block content %}
  <div class="hero">
    <h2>图片切分/拼装</h2>
    <p>切分：一张图按样式拆分多张；拼装：多张图按样式组合成一张，可拖动调整位置。</p>
  </div>

  <div class="grid">
    <div class="card wide">
      <div class="bd">
        <div class="row" style="margin-bottom: 12px;">
          <button id="tabSlice" class="btn primary" type="button">切分</button>
          <button id="tabCompose" class="btn secondary" type="button">拼装</button>
          <span class="muted">切换后当前配置会保留</span>
        </div>

        <div id="imgSliceError" class="error" style="margin-bottom: 12px; {% if not error %}display:none{% endif %}">
          <span id="imgSliceErrorText">{{ error or "" }}</span>
        </div>

        <form id="imgSliceForm" action="{{ url_for('image.slice_submit') }}" method="post" enctype="multipart/form-data" target="_blank">
          <div class="cols">
            <div class="col-7">
              <div class="field">
                <label>选择图片</label>
                <input id="imgSliceFile" type="file" name="file" accept="image/*" required />
              </div>
              <div class="field">
                <label>切分样式</label>
                {% set m = (options.mode if options else 'grid_3') %}
                <select id="imgSliceMode" name="mode">
                  <option value="split_v2" {% if m == 'split_v2' %}selected{% endif %}>两张（左右对半）</option>
                  <option value="split_h2" {% if m == 'split_h2' %}selected{% endif %}>两张（上下对半）</option>
                  <option value="grid_2" {% if m == 'grid_2' %}selected{% endif %}>四宫格（2×2）</option>
                  <option value="grid_2x3" {% if m == 'grid_2x3' %}selected{% endif %}>六宫格（2×3）</option>
                  <option value="grid_3" {% if m == 'grid_3' %}selected{% endif %}>九宫格（3×3）</option>
                </select>
              </div>
            </div>

            <div class="col-5">
              <div class="field">
                <label>输出格式</label>
                {% set f = (options.output_format if options else 'same') %}
                <select name="output_format">
                  <option value="same" {% if f == 'same' %}selected{% endif %}>跟随原图</option>
                  <option value="png" {% if f == 'png' %}selected{% endif %}>PNG</option>
                  <option value="jpg" {% if f == 'jpg' %}selected{% endif %}>JPG（透明会变白底）</option>
                  <option value="webp" {% if f == 'webp' %}selected{% endif %}>WEBP</option>
                </select>
              </div>
              <button class="btn primary" type="submit">一键下载切图（zip）</button>
                <div class="hint">提示：下载会在新标签页触发，当前页保留预览。</div>
            </div>
          </div>
        </form>

        <div class="preview" style="margin-top: 14px;">
          <div class="bar">
            <div class="title">切分预览</div>
            <div id="imgSlicePreviewMeta" class="muted"></div>
          </div>
          <div class="body">
            <canvas id="imgSliceCanvas" style="height: 520px;"></canvas>
          </div>
        </div>

        <div id="composeWrap" style="display:none;">
          <div class="cols" style="margin-top: 16px;">
            <div class="col-7">
              <div class="field">
                <label>选择多张图片</label>
                <input id="imgComposeFiles" type="file" accept="image/*" multiple />
                <div class="hint">图片只在本地浏览器处理；按选择顺序自动填充拼装格子。</div>
              </div>
              <div class="preview">
                <div class="bar">
                  <div class="title">拼装预览（可拖动图片调整位置）</div>
                  <div id="imgComposeMeta" class="muted"></div>
                </div>
                <div class="body">
                  <canvas id="imgComposeCanvas" style="height: 520px;"></canvas>
                </div>
              </div>
            </div>

            <div class="col-5">
              <div class="field">
                <label>拼装样式</label>
                <select id="imgComposeLayout">
                  <option value="split_v2">两张（左右）</option>
                  <option value="split_h2">两张（上下）</option>
                  <option value="grid_2">四宫格（2×2）</option>
                  <option value="grid_2x3">六宫格（2×3）</option>
                  <option value="grid_3">九宫格（3×3）</option>
                </select>
              </div>
              <div class="field">
                <label>导出宽度（像素）</label>
                <input id="imgComposeWidth" type="number" min="512" max="8192" value="2048" />
                <div class="hint">高度会按拼装样式自动计算；越大越清晰但导出更慢。</div>
              </div>
              <div class="field">
                <label>导出格式</label>
                <select id="imgComposeFormat">
                  <option value="png">PNG（无损）</option>
                  <option value="webp">WEBP（无损）</option>
                  <option value="jpg">JPG（高质量）</option>
                </select>
              </div>
              <div class="row">
                <button id="imgComposeExport" class="btn primary" type="button">导出为一张图片</button>
                <button id="imgComposeReset" class="btn secondary" type="button">重置位置</button>
              </div>
              <div class="hint">拖动：在预览图里按住并拖动某一格内的图片即可调整裁切位置。</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const tabSlice = document.getElementById("tabSlice");
      const tabCompose = document.getElementById("tabCompose");
      const composeWrap = document.getElementById("composeWrap");

      const form = document.getElementById("imgSliceForm");
      const fileInput = document.getElementById("imgSliceFile");
      const modeSelect = document.getElementById("imgSliceMode");
      const canvas = document.getElementById("imgSliceCanvas");
      const meta = document.getElementById("imgSlicePreviewMeta");
      const ctx = canvas.getContext("2d");

      let loadedImg = null;
      let loadedUrl = null;

      function modeToGrid(mode) {
        if (mode === "split_v2") return [1, 2];
        if (mode === "split_h2") return [2, 1];
        if (mode === "grid_2") return [2, 2];
        if (mode === "grid_2x3") return [2, 3];
        return [3, 3];
      }

      function clear() {
        loadedImg = null;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        meta.textContent = "";
      }

      function setTab(which) {
        const isSlice = which === "slice";
        form.style.display = isSlice ? "" : "none";
        canvas.closest(".preview").style.display = isSlice ? "" : "none";
        composeWrap.style.display = isSlice ? "none" : "";
        tabSlice.className = isSlice ? "btn primary" : "btn secondary";
        tabCompose.className = isSlice ? "btn secondary" : "btn primary";
        setTimeout(() => window.dispatchEvent(new Event("resize")), 0);
      }

      function draw() {
        if (!loadedImg) return;

        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const cssW = Math.max(1, rect.width || 1);
        const cssH = 520;

        canvas.style.height = cssH + "px";
        canvas.width = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, cssW, cssH);
        ctx.fillStyle = "#0b1220";
        ctx.fillRect(0, 0, cssW, cssH);

        const imgW = loadedImg.width;
        const imgH = loadedImg.height;
        const scale = Math.min(cssW / imgW, cssH / imgH);
        const drawW = Math.round(imgW * scale);
        const drawH = Math.round(imgH * scale);
        const offsetX = Math.round((cssW - drawW) / 2);
        const offsetY = Math.round((cssH - drawH) / 2);
        ctx.drawImage(loadedImg, offsetX, offsetY, drawW, drawH);

        const [rows, cols] = modeToGrid(modeSelect.value);
        meta.textContent = `预览：${rows}×${cols}`;

        function drawLine(x1, y1, x2, y2) {
          // Dark outline + light core so it’s visible on both dark and white images.
          ctx.save();
          ctx.shadowColor = "rgba(0,0,0,0)";
          ctx.shadowBlur = 0;

          ctx.lineCap = "butt";
          ctx.setLineDash([6, 4]);

          ctx.lineWidth = 3;
          ctx.strokeStyle = "rgba(0,0,0,0.75)";
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();

          ctx.lineWidth = 1;
          ctx.strokeStyle = "rgba(255,255,255,0.95)";
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();

          ctx.restore();
        }

        for (let c = 1; c < cols; c++) {
          const x = offsetX + (drawW * c) / cols;
          drawLine(x, offsetY, x, offsetY + drawH);
        }
        for (let r = 1; r < rows; r++) {
          const y = offsetY + (drawH * r) / rows;
          drawLine(offsetX, y, offsetX + drawW, y);
        }
      }

      function loadFile() {
        const f = fileInput.files && fileInput.files[0];
        if (!f) {
          if (loadedUrl) URL.revokeObjectURL(loadedUrl);
          loadedUrl = null;
          clear();
          return;
        }
        if (loadedUrl) URL.revokeObjectURL(loadedUrl);
        loadedUrl = URL.createObjectURL(f);

        const img = new Image();
        img.onload = () => {
          loadedImg = img;
          draw();
        };
        img.onerror = () => {
          clear();
        };
        img.src = loadedUrl;
      }

      fileInput.addEventListener("change", loadFile);
      modeSelect.addEventListener("change", draw);
      window.addEventListener("resize", () => {
        if (loadedImg) draw();
      });

      clear();
      setTab("slice");
      tabSlice.addEventListener("click", () => setTab("slice"));
      tabCompose.addEventListener("click", () => setTab("compose"));
    })();
  </script>
  <script src="{{ url_for('static', filename='js/image_compose.js') }}"></script>
{% endblock %}
